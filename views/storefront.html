<!DOCTYPE html>
<html>
<!--
    Barebone Storefront API sameple.

    Read these first.
    https://shopify.dev/docs/api/usage/authentication#access-tokens-for-the-storefront-api
    https://shopify.dev/docs/custom-storefronts/building-with-the-storefront-api/
    https://shopify.dev/docs/api/storefront

  -->

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My barebone app storefront API sample</title>
  <style>
    div {
      margin-left: 20%;
      margin-right: 20%;
      text-align: center;
    }

    pre {
      text-align: left;
      max-width: 500px;
    }

    button {
      font-size: x-large;
    }
  </style>
</head>

<body>
  <div>
    <h1>Plain Custom Storefront</h1>

    <h2><a href="https://shopify.dev/docs/api/usage/authentication#access-tokens-for-the-storefront-api"
        target="_blank">Dev. doc(1)</a>

      <a href="https://shopify.dev/docs/custom-storefronts/building-with-the-storefront-api/" target="_blank">Dev.
        doc(2)</a>

      <a href="https://shopify.dev/docs/api/storefront" target="_blank">Dev.
        doc(3)</a>
    </h2>

    <h3><a href="https://github.com/benzookapi/shopify-barebone-app-sample/blob/main/views/storefront.html"
        target="_blank">Get the code</a></h3>

    <div><b>Store:</b></div>
    <div>
      <%= shop %>
    </div>
    <p></p>

    <div><b>Public Token:</b></div>
    <div>
      <%= public_token %>
    </div>
    <p></p>

    <div><b>Your IP Address:</b></div>
    <div>
      <span id="ip_address"></span>
    </div>
    <p></p>

    <div><b>Leave your note:</b></div>
    <div>
      <textarea id="note">This is my custom storefront purchase...</textarea>
    </div>
    <p></p>

    <div><b>Select your locale:</b></div>
    <div>
      <select id="locale">
        <option value="EN-US">EN-US</option>
        <option value="JA-JP">JA-JP</option>
        <option value="FR-FR">FR-FR</option>
      </select>
    </div>
    <p></p>

    <div><b>Select your checkout flow:</b></div>
    <div> <input type="radio" value="checkout" name="flow" id="flow_checkout" checked>Checkout without cart</input>
    </div>
    <div>
      <input type="radio" value="cart" name="flow" id="flow_cart">Add to cart and checkout</input>
    </div>
    <p></p>

    <div><b>How do you call Storefront API?</b></div>
    <div> <input type="radio" value="public" name="type" id="type_public" checked>Call on this page with the
      given public
      token <br /> (view the
      page
      source!)</input>
    </div>
    <div>
      <input type="radio" value="private" id="type_private" name="type">Call on the server side with the
      stored private
      token mixed with
      Admin
      API <br /> (you need to install this app to the store first!)</input>
    </div>
    <p></p>

    <fieldset>
      <button id="show_product">1. Show products to checkout</button>
      <p></p>
      <div>
        <pre id="products"></pre>
        <p>
          <a href="" target="_blank" id="products_doc" style="visibility: hidden;">The used API. doc</a>
        </p>
      </div>
    </fieldset>
    <p></p>

    <fieldset class="default_hidden layer_2 flow_checkout" style="display: none;">
      <button id="create_checkout">2. Create a checkout with the listed products</button>
      <p></p>
      <div>
        <pre id="checkout" class="default_empty"></pre>
        <p>
          <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutCreate" target="_blank">The used
            API. doc</a>
        </p>
        <h2 style="display: none;" id="checkout_1" class="default_hidden">
          <a href="" target="_blank" id="checkout_1_link">üëâ Checkout through the link of 'webUrl'</a>
          <br /><br />Or
          <br />‚¨áÔ∏è
        </h2>
      </div>
    </fieldset>
    <p></p>

    <fieldset class="default_hidden layer_2 flow_cart" style="display: none;">
      <button id="create_cart">2. Create a cart to add the listed products</button>
      <p></p>
      <div>
        <pre id="cart" class="default_empty"></pre>
        <p>
          <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/cartCreate" target="_blank">The used
            API. doc</a>
        </p>
        <h2 style="display: none;" id="cart_1" class="default_hidden">
          <a href="" target="_blank" id="cart_1_link">üëâ Checkout through the link of 'checkoutUrl'</a>
          <br /><br />Or
          <br />‚¨áÔ∏è
        </h2>
      </div>
    </fieldset>
    <p></p>


    <fieldset class="default_hidden layer_3" style="display: none;">
      <p>
        <label for="email">Email: </label><input type="text" name="email" value="" id="email">
      </p>
      <p>
        <label for="password">Password: </label><input type="password" name="password" value="" id="password">
      </p>
      <button id="login_customer">3. Login as a customer (optional)</button>
      <p></p>
      <div>
        <pre id="customer_token" class="default_empty"></pre>
        <pre id="customer_associate" class="default_empty"></pre>
        <p>
          <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/customerAccessTokenCreate"
            target="_blank">The used API. doc</a>
          <br />
          <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutCustomerAssociateV2"
            target="_blank">The used API. doc</a>
        </p>
      </div>
    </fieldset>
    <p></p>

    <fieldset class="default_hidden layer_3 flow_checkout" style="display: none;">
      <button id="apply_address">3. Appy the preset or customer's shipping address to the checktout</button>
      <p></p>
      <div>
        <pre id="address" class="default_empty"></pre>
        <p>
          <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutShippingAddressUpdateV2"
            target="_blank">The used
            API. doc</a>
        </p>
        <h2 style="display: none;" id="checkout_2" class="default_hidden">
          <a href="" target="_blank" id="checkout_2_link">üëâ Checkout through the link of 'webUrl'</a>
          <br /><br />Or
          <br />‚¨áÔ∏è
        </h2>
      </div>
    </fieldset>
    <p></p>

    <fieldset class="default_hidden layer_4 flow_checkout" style="display: none;">
      <button id="set_rate">4. Set the last shipping rate to the checkout</button>
      <p></p>
      <div>
        <pre id="rate" class="default_empty"></pre>
        <pre id="rate_selected" class="default_empty"></pre>
        <p>
          <a href="https://shopify.dev/docs/api/storefront/unstable/objects/Checkout" target="_blank">The used
            API. doc</a>
          <br />
          <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutShippingLineUpdate"
            target="_blank">The used
            API. doc</a>
        </p>
        <h2 style="display: none;" id="checkout_3" class="default_hidden">
          <a href="" target="_blank" id="checkout_3_link">üëâ Checkout through the link of 'webUrl'</a>
        </h2>
      </div>
    </fieldset>
    <p></p>

  </div>
  <script>
    // Call Shopify Storefront API directly over CORS with the public token.
    const callStorefrontAPI = (query, variables, ip_address, callback) => {
      const url = `https://<%= shop %>/api/<%= api_version %>/graphql.json`;
      console.log(`callStorefrontAPI: calling... ${url} with query ${query} and variables ${JSON.stringify(variables, null, 4)} and ip_address ${ip_address}`);
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Shopify-Storefront-Access-Token": "<%= public_token %>",
          "Shopify-Storefront-Buyer-IP": ip_address
        },
        body: JSON.stringify({
          "query": query.replace(/\n/g, ''),
          "variables": variables
        })
      }).then((res) => {
        res.json().then((data, errors) => {
          console.log(`callStorefrontAPI response: ${JSON.stringify(data, null, 4)}`);
          data.data.used_api = "Client side Storefront API";
          callback(data);
        });
      });
    };

    // Access to the app server to call Admin / Storefront APIs with the private (delegated) token in the shop metafield.
    const accessAppServer = (action, variables, ip_address, callback) => {
      const url = `/storefront?action=${action}`;
      console.log(`accessAppServer: calling... ${url}`);
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          "shop": "<%= shop %>",
          "variables": variables,
          "ip_address": ip_address
        })
      }).then((res) => {
        res.json().then((data, errors) => {
          console.log(`accessAppServer response: ${JSON.stringify(data, null, 4)}`);
          callback(data);
        });
      });
    };

    // Get the IP address.
    fetch('https://api.ipify.org?format=json', {
      method: "GET"
    }).then((res) => {
      res.json().then((json) => {
        document.getElementById('ip_address').innerHTML = json.ip;
      });
    });

    const getLocale = () => {
      const locale = document.getElementById('locale').options[document.getElementById('locale').selectedIndex].value;
      const lang = locale.split('-')[0];
      const country = locale.split('-')[1];
      return {
        "lang": lang,
        "country": country
      };
    };

    const getFlow = () => {
      return document.getElementById('flow_checkout').checked == true ? "flow_checkout" : "flow_cart";
    };

    // 1. Show the products to checkout with APIs.
    document.getElementById('show_product').onclick = () => {
      const products = document.getElementById('products');
      products.innerHTML = 'Loading...';

      document.querySelectorAll('.default_hidden').forEach((e) => {
        e.style = "display: none;";
      });
      document.querySelectorAll('.default_empty').forEach((e) => {
        e.innerHTML = '';
      });

      const locale = getLocale();

      const callback = (data) => {
        products.innerHTML = JSON.stringify(data.data, null, 4);
        document.querySelectorAll(`.layer_2.${getFlow()}`).forEach((e) => {
          e.style = "visibility: visible;";
        });
        const doc = document.getElementById('products_doc');
        doc.style = "visibility: visible;";
        if (document.getElementById('type_public').checked) {
          doc.href = "https://shopify.dev/docs/api/storefront/unstable/queries/products";
        } else {
          doc.href = "https://shopify.dev/docs/api/admin-graphql/unstable/queries/products";
        }
      };
      if (document.getElementById('type_public').checked) {
        // Use the public token.
        // See https://shopify.dev/docs/api/storefront/unstable/queries/products
        callStorefrontAPI(`query products @inContext(country: ${locale.country}, language: ${locale.lang}) {
                  products(first: 3) {
                    edges {
                      node {
                        id
                        title
                        variants(first: 1) {
                          edges {
                            node {
                              id
                              title
                              price {
                                amount
                                currencyCode
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }`, null, document.getElementById('ip_address').innerHTML, callback);
      } else {
        // Use the private token (IP address is not used for Admin API calls).
        accessAppServer(`show_product`, null, null, callback);
      }
    };

    // 2. Create a checkout.
    document.getElementById('create_checkout').onclick = () => {
      const checkout = document.getElementById('checkout');
      checkout.innerHTML = 'Loading...';

      const callback = (data) => {
        checkout.innerHTML = JSON.stringify(data.data, null, 4);
        document.getElementById('checkout_1').style = "visibility: visible;";
        document.getElementById('checkout_1_link').href = data.data.checkoutCreate.checkout.webUrl;

        document.querySelectorAll('.layer_3').forEach((e) => {
          e.style = "visibility: visible;";
        });
      };

      const listed_products = JSON.parse(document.getElementById('products').innerHTML);
      const line_items = [];
      listed_products.products.edges.map((e) => {
        e.node.variants.edges.map((e2) => {
          line_items.push({
            "variantId": e2.node.id,
            "quantity": 1,
            "customAttributes": {
              "key": "bareboneapp.storefront_product_id",
              "value": e.node.id
            }
          });
        });
      });
      const input = {
        "customAttributes": [
          {
            "key": "bareboneapp.storefront_ip",
            "value": document.getElementById('ip_address').innerHTML
          }
        ],
        "lineItems": line_items,
        "note": document.getElementById('note').value
      };

      const locale = getLocale();

      if (document.getElementById('type_public').checked) {
        // Use the public token.
        // See https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutCreate
        callStorefrontAPI(`mutation checkoutCreate($input: CheckoutCreateInput!) @inContext(country: ${locale.country}, language: ${locale.lang}) {
                  checkoutCreate(input: $input) {
                    checkout {
                      id
                      orderStatusUrl
                      ready
                      requiresShipping
                      lineItems(first: 10) {
                        edges {
                          node {
                            id
                            quantity
                            title
                          }
                        }
                      }
                      webUrl
                    }
                    checkoutUserErrors {
                      code
                      field
                      message
                    }
                    queueToken
                  }
                }`, {
          "input": input
        }, document.getElementById('ip_address').innerHTML, callback);
      } else {
        // Use the private token (passing the IP address to server side Storefront API).
        accessAppServer(`create_checkout&locale=${JSON.stringify(locale)}`, input, document.getElementById('ip_address').innerHTML, callback);
      }
    };

    // 2. Create a cart.
    document.getElementById('create_cart').onclick = () => {
      const cart = document.getElementById('cart');
      cart.innerHTML = 'Loading...';

      const callback = (data) => {
        cart.innerHTML = JSON.stringify(data.data, null, 4);
        document.getElementById('cart_1').style = "visibility: visible;";
        document.getElementById('cart_1_link').href = data.data.cartCreate.cart.checkoutUrl;

        document.querySelectorAll('.layer_3').forEach((e) => {
          e.style = "visibility: visible;";
        });
      };

      const listed_products = JSON.parse(document.getElementById('products').innerHTML);
      const line_items = [];
      listed_products.products.edges.map((e) => {
        e.node.variants.edges.map((e2) => {
          line_items.push({
            "merchandiseId": e2.node.id,
            "quantity": 1,
            "attributes": {
              "key": "bareboneapp.storefront_product_id",
              "value": e.node.id
            }
          });
        });
      });

      const input = {
        "attributes": [
          {
            "key": "bareboneapp.storefront_ip",
            "value": document.getElementById('ip_address').innerHTML
          }
        ],
        "lines": line_items[0],
        "metafields": [
          {
            "key": "bareboneapp.storefront_timestamp",
            "type": "single_line_text_field",
            "value": `${new Date().toISOString()}`
          }
        ],
        "note": document.getElementById('note').value
      };

      const locale = getLocale();

      if (document.getElementById('type_public').checked) {
        // Use the public token.
        // See https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutCreate
        callStorefrontAPI(`mutation cartCreate($input: CartInput!) {
          cartCreate(input: $input) {
             cart {
               id
               totalQuantity
               cost {
                checkoutChargeAmount {
                  amount
                  currencyCode
                }
                subtotalAmount {
                  amount
                  currencyCode
                }
                totalAmount {
                  amount
                  currencyCode
                }
                totalDutyAmount {
                  amount
                  currencyCode
                }
                totalTaxAmount {
                  amount
                  currencyCode
                }
               }
               lines(first: 10) {
                edges {
                  node {
                    id
                    quantity
                    merchandise {
                      ... on ProductVariant {
                        id
                        title
                      }
                    }
                  }
                }
               }
               checkoutUrl
             }
             userErrors {
                field
                message
              }
            }
          }`, {
          "input": input
        }, document.getElementById('ip_address').innerHTML, callback);
      } else {
        // Use the private token (passing the IP address to server side Storefront API).
        accessAppServer(`create_cart&locale=${JSON.stringify(locale)}`, input, document.getElementById('ip_address').innerHTML, callback);
      }
    };

    // 3. Login as a customer (optional).
    document.getElementById('login_customer').onclick = () => {
      const customer_token = document.getElementById('customer_token');
      customer_token.innerHTML = 'Loading...';

      const callback = (data) => {
        customer_token.innerHTML = JSON.stringify(data.data, null, 4);

        if (getFlow() === 'flow_cart') return;

        const customer_associate = document.getElementById('customer_associate');
        customer_associate.innerHTML = 'Loading...';

        const callback2 = (data) => {
          customer_associate.innerHTML = JSON.stringify(data.data, null, 4);
        };

        const checkout = JSON.parse(document.getElementById('checkout').innerHTML);

        const input = {
          "checkoutId": checkout.checkoutCreate.checkout.id,
          "customerAccessToken": data.data.customerAccessTokenCreate.customerAccessToken.accessToken
        }

        if (document.getElementById('type_public').checked) {
          // Use the public token.
          // See https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutCustomerAssociateV2
          callStorefrontAPI(`mutation checkoutCustomerAssociateV2($checkoutId: ID!, $customerAccessToken: String!) {
                    checkoutCustomerAssociateV2(checkoutId: $checkoutId, customerAccessToken: $customerAccessToken) {
                      checkout {
                        id
                        orderStatusUrl
                        ready
                        requiresShipping
                        lineItems(first: 10) {
                          edges {
                            node {
                              id
                              quantity
                              title
                            }
                          }
                        }
                        email
                        shippingAddress {
                          address1
                          address2
                          city
                          company
                          country
                          countryCodeV2
                          firstName
                          lastName
                          phone
                          province
                          provinceCode
                          zip
                        }
                        webUrl
                      }
                      checkoutUserErrors {
                        code
                        field
                        message
                      }
                      customer {
                        id
                        email
                        addresses(first: 10) {
                          edges {
                            node {
                              address1
                              address2
                              city
                              company
                              country
                              countryCodeV2
                              firstName
                              lastName
                              phone
                              province
                              provinceCode
                              zip
                            }
                          }                          
                        }
                      }
                    }
                   }`, input, document.getElementById('ip_address').innerHTML, callback2);
        } else {
          // Use the private token (passing the IP address to server side Storefront API).
          accessAppServer('customer_associate', input, document.getElementById('ip_address').innerHTML, callback2);
        }
      };

      const input = {
        "email": document.getElementById('email').value,
        "password": document.getElementById('password').value
      };
      if (document.getElementById('type_public').checked) {
        // Use the public token.
        // See https://shopify.dev/docs/api/storefront/unstable/mutations/customerAccessTokenCreate
        callStorefrontAPI(`mutation customerAccessTokenCreate($input: CustomerAccessTokenCreateInput!) {
                  customerAccessTokenCreate(input: $input) {
                    customerAccessToken {
                      accessToken
                      expiresAt
                    }
                    customerUserErrors {
                      code
                      field
                      message
                    }
                  }
                }`, {
          "input": input
        }, document.getElementById('ip_address').innerHTML, callback);
      } else {
        // Use the private token (passing the IP address to server side Storefront API).
        accessAppServer('login_customer', input, document.getElementById('ip_address').innerHTML, callback);
      }
    };

    // 3. Apply the preset or customer's shipping address to the checkout
    document.getElementById('apply_address').onclick = () => {
      const address = document.getElementById('address');
      address.innerHTML = 'Loading...';

      const callback = (data) => {
        address.innerHTML = JSON.stringify(data.data, null, 4);
        document.getElementById('checkout_2').style = "visibility: visible;";
        document.getElementById('checkout_2_link').href = data.data.checkoutShippingAddressUpdateV2.checkout.webUrl;

        document.querySelectorAll('.layer_4').forEach((e) => {
          e.style = "visibility: visible;";
        });
      };

      const checkout = JSON.parse(document.getElementById('checkout').innerHTML);

      const input = {
        "checkoutId": checkout.checkoutCreate.checkout.id,
        "shippingAddress": {
          "address1": "barebone street 1",
          "address2": "barebone street 2",
          "city": "Shibuya",
          "company": "Barebone corp.",
          "country": "JP",
          "firstName": "Bare",
          "lastName": "Bone",
          "phone": "+819012345678",
          "province": "Tokyo",
          "zip": "1500001"
        }
      };

      if (document.getElementById('customer_associate').innerHTML !== '') {
        const customer_address = JSON.parse(document.getElementById('customer_associate').innerHTML);
        input.shippingAddress = customer_address.checkoutCustomerAssociateV2.customer.addresses.edges[0].node;
        delete input.shippingAddress.countryCodeV2;
        delete input.shippingAddress.provinceCode;
      }

      if (document.getElementById('type_public').checked) {
        // Use the public token.
        // See https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutShippingAddressUpdateV2
        callStorefrontAPI(`mutation checkoutShippingAddressUpdateV2($checkoutId: ID!, $shippingAddress: MailingAddressInput!) {
                  checkoutShippingAddressUpdateV2(checkoutId: $checkoutId, shippingAddress: $shippingAddress) {
                    checkout {
                      id
                      orderStatusUrl
                      ready
                      requiresShipping
                      lineItems(first: 10) {
                        edges {
                          node {
                            id
                            quantity
                            title
                          }
                        }
                      }
                      email
                      shippingAddress {
                        address1
                        address2
                        city
                        company
                        country
                        countryCodeV2
                        firstName
                        lastName
                        phone
                        province
                        provinceCode
                        zip
                      }
                      webUrl
                    }
                    checkoutUserErrors {
                      code
                      field
                      message
                    }
                  }
                }`, input, document.getElementById('ip_address').innerHTML, callback);
      } else {
        // Use the private token (passing the IP address to server side Storefront API).
        accessAppServer('apply_address', input, document.getElementById('ip_address').innerHTML, callback);
      }
    };

    // 4. Set the last shipping rate to the checkout.
    document.getElementById('set_rate').onclick = () => {
      const rate = document.getElementById('rate');
      rate.innerHTML = 'Loading...';

      const callback = (data) => {
        rate.innerHTML = JSON.stringify(data.data, null, 4);

        const rate_selected = document.getElementById('rate_selected');
        rate_selected.innerHTML = 'Loading...';

        const callback2 = (data) => {
          rate_selected.innerHTML = JSON.stringify(data.data, null, 4);
          document.getElementById('checkout_3').style = "visibility: visible;";
          document.getElementById('checkout_3_link').href = data.data.checkoutShippingLineUpdate.checkout.webUrl;
        };

        const checkout = JSON.parse(document.getElementById('checkout').innerHTML);

        const size = data.data.node.availableShippingRates.shippingRates.length;

        const input = {
          "checkoutId": checkout.checkoutCreate.checkout.id,
          "shippingRateHandle": data.data.node.availableShippingRates.shippingRates[size - 1].handle
        };

        if (document.getElementById('type_public').checked) {
          // Use the public token.
          // See https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutShippingLineUpdate
          callStorefrontAPI(`mutation checkoutShippingLineUpdate($checkoutId: ID!, $shippingRateHandle: String!) {
            checkoutShippingLineUpdate(checkoutId: $checkoutId, shippingRateHandle: $shippingRateHandle) {
              checkout {
                id
                orderStatusUrl
                ready
                requiresShipping
                lineItems(first: 10) {
                  edges {
                      node {
                        id
                        quantity
                        title
                      }
                  }
                }
                email
                shippingAddress {
                  address1
                  address2
                  city
                  company
                  country
                  countryCodeV2
                  firstName
                  lastName
                  phone
                  province
                  provinceCode
                  zip
                }
                shippingLine {
                  handle
                  title
                  price {
                    amount
                    currencyCode
                  }
                }
                webUrl            
              }
              checkoutUserErrors {
                code
                field
                message
              }
             }
          }`, input, document.getElementById('ip_address').innerHTML, callback2);
        } else {
          // Use the private token (passing the IP address to server side Storefront API).
          accessAppServer('rate_selected', input, document.getElementById('ip_address').innerHTML, callback2);
        }
      };

      const checkout = JSON.parse(document.getElementById('checkout').innerHTML);

      if (document.getElementById('type_public').checked) {
        // Use the public token.
        // See https://shopify.dev/docs/api/storefront/unstable/objects/Checkout
        callStorefrontAPI(`{
          node(id: "${checkout.checkoutCreate.checkout.id}") {
            id
            ... on Checkout {
              availableShippingRates { 
                ready
                shippingRates {
                  handle
                  title
                  price {
                    amount
                    currencyCode
                  }     
                }           
              }
            }
          }
        }`, null, document.getElementById('ip_address').innerHTML, callback);
      } else {
        // Use the private token (passing the IP address to server side Storefront API).
        accessAppServer(`set_rate&id=${checkout.checkoutCreate.checkout.id}`, null, document.getElementById('ip_address').innerHTML, callback);
      }
    };

  </script>
</body>

</html>