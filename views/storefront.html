<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My barebone app storefront API sample</title>
    <style>
        div {
            margin-left: 20%;
            margin-right: 20%;
            text-align: center;
        }

        pre {
            text-align: left;
            max-width: 500px;
        }

        button {
            font-size: x-large;
        }
    </style>
</head>

<body>
    <div>
        <h1>Plain Custom Storefront</h1>

        <h2><a href="https://shopify.dev/docs/api/usage/authentication#access-tokens-for-the-storefront-api"
                target="_blank">Dev. doc</a></h2>

        <h3><a href="https://github.com/benzookapi/shopify-barebone-app-sample/blob/main/views/storefront.html"
                target="_blank">Get the code</a></h3>

        <div><b>Store:</b></div>
        <div>
            <%= shop %>
        </div>
        <p></p>

        <div><b>Public Token:</b></div>
        <div>
            <%= public_token %>
        </div>
        <p></p>

        <div><b>Your IP Address:</b></div>
        <div>
            <span id="ip_address"></span>
        </div>
        <p></p>

        <div><b>How do you call Storefront API?</b></div>
        <div> <input type="radio" value="public" name="type" id="type_public" checked>Call on this page with the
            given public
            token <br /> (view the
            page
            source!)</input>
        </div>
        <div>
            <input type="radio" value="private" id="type_private" name="type">Call on the server side with the
            stored private
            token mixed with
            Admin
            API <br /> (you need to install this app to the store first!)</input>
        </div>
        <p></p>

        <fieldset>
            <button id="show_product">1. Show products to checkout</button>
            <p></p>
            <div>
                <pre id="products"></pre>
                <p>
                    <a href="" target="_blank" id="products_doc" style="visibility: hidden;">The used API. doc</a>
                </p>
            </div>
        </fieldset>
        <p></p>

        <fieldset class="default_hidden" style="visibility: hidden;">
            <p>
                <label for="email">Email: </label><input type="text" name="email" value="" id="email">
            </p>
            <p>
                <label for="password">Password: </label><input type="password" name="password" value="" id="password">
            </p>
            <button id="login_customer">2. Login as a customer (optional)</button>
            <p></p>
            <div>
                <pre id="customer"></pre>
                <p>
                    <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/customerAccessTokenCreate"
                        target="_blank">The used API. doc</a>
                </p>
            </div>
        </fieldset>
        <p></p>

        <fieldset class="default_hidden" style="visibility: hidden;">
            <button id="create_checkout">2. Create a checkout link with the listed products added.</button>
            <p></p>
            <div>
                <pre id="checkout"></pre>
                <p>
                    <a href="https://shopify.dev/docs/api/storefront/unstable/mutations/checkoutCreate"
                        target="_blank">The used API. doc</a>
                </p>
            </div>
        </fieldset>
        <p></p>



    </div>
    <script>
        // Call Shopify Storefront API directly over CORS with the public token.
        const callStorefrontAPI = (query, variables, ip_address, callback) => {
            const url = `https://<%= shop %>/api/unstable/graphql.json`;
            console.log(`callStorefrontAPI: calling... ${url} with query ${query} and variables ${JSON.stringify(variables, null, 4)} and ip_address ${ip_address}`);
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Shopify-Storefront-Access-Token": "<%= public_token %>",
                    "Shopify-Storefront-Buyer-IP": ip_address
                },
                body: JSON.stringify({
                    "query": query.replace(/\n/g, ''),
                    "variables": variables
                })
            }).then((res) => {
                res.json().then((data, errors) => {
                    console.log(`callStorefrontAPI response: ${JSON.stringify(data, null, 4)}`);
                    data.data.used_api = "Client side Storefront API";
                    callback(data);
                });
            });
        };

        // Access to the app server to call Admin / Storefront APIs with the private (delegated) token in the shop metafield.
        const accessAppServer = (action, variables, ip_address, callback) => {
            const url = `/storefront?action=${action}`;
            console.log(`accessAppServer: calling... ${url}`);
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "shop": "<%= shop %>",
                    "variables": variables,
                    "ip_address": ip_address
                })
            }).then((res) => {
                res.json().then((data, errors) => {
                    console.log(`accessAppServer response: ${JSON.stringify(data, null, 4)}`);
                    callback(data);
                });
            });
        };

        // Get the IP address.
        fetch('https://api.ipify.org?format=json', {
            method: "GET"
        }).then((res) => {
            res.json().then((json) => {
                document.getElementById('ip_address').innerHTML = json.ip;
            });
        });

        // 1. Show the products to checkout with APIs.
        document.getElementById('show_product').onclick = () => {
            const products = document.getElementById('products');
            products.innerHTML = 'Loading...';

            document.getElementById('customer').innerHTML = '';

            document.querySelectorAll('.default_hidden').forEach((e) => {
                e.style = "visibility: hidden;";
            });

            const callback = (data) => {
                products.innerHTML = JSON.stringify(data.data, null, 4);
                document.querySelectorAll('.default_hidden').forEach((e) => {
                    e.style = "visibility: visible;";
                });
                const doc = document.getElementById('products_doc');
                doc.style = "visibility: visible;";
                if (document.getElementById('type_public').checked) {
                    doc.href = "https://shopify.dev/docs/api/storefront/unstable/queries/products";
                } else {
                    doc.href = "https://shopify.dev/docs/api/admin-graphql/unstable/queries/products";
                }
            };
            if (document.getElementById('type_public').checked) {
                // Use the public token.
                callStorefrontAPI(`{
                  products(first: 3) {
                    edges {
                      node {
                        id
                        title
                        variants(first: 1) {
                          edges {
                            node {
                              id
                              title
                            }
                          }
                        }
                      }
                    }
                  }
                }`, null, document.getElementById('ip_address').innerHTML, callback);
            } else {
                // Use the private token (IP address is not used for Admin API calls).
                accessAppServer('show_product', null, null, callback);
            }
        };

        // 2. Login as a customer (optional).
        document.getElementById('login_customer').onclick = () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const customer = document.getElementById('customer');
            customer.innerHTML = 'Loading...';

            const callback = (data) => {
                customer.innerHTML = JSON.stringify(data.data, null, 4);
            };

            const input = {
                "email": email,
                "password": password
            };
            if (document.getElementById('type_public').checked) {
                // Use the public token.
                callStorefrontAPI(`mutation customerAccessTokenCreate($input: CustomerAccessTokenCreateInput!) {
                  customerAccessTokenCreate(input: $input) {
                    customerAccessToken {
                      accessToken
                      expiresAt
                    }
                    customerUserErrors {
                      code
                      field
                      message
                    }
                  }
                }`, {
                    "input": input
                }, document.getElementById('ip_address').innerHTML, callback);
            } else {
                // Use the private token (passing the IP address to server side Storefront API).
                accessAppServer('login_customer', input, document.getElementById('ip_address').innerHTML, callback);
            }
        };

        // 2. Create a checkout with dummy info.
        document.getElementById('create_checkout').onclick = () => {
            const customer = document.getElementById('checkout');
            customer.innerHTML = 'Loading...';

            const callback = (data) => {
                customer.innerHTML = JSON.stringify(data.data, null, 4);
            };

            const listed_products = JSON.parse(document.getElementById('products').innerHTML);
            const line_items = [];
            listed_products.products.edges.map((e) => {
                e.node.variants.edges.map((e2) => {
                    line_items.push({
                        "variantId": e2.node.id,
                        "quantity": 1,
                        "customAttributes": {
                            "key": "bareboneapp.storefront_product_id",
                            "value": e.node.id
                        }
                    });
                });
            });
            const input = {
                "customAttributes": [
                    {
                        "key": "bareboneapp.storefront_ip",
                        "value": document.getElementById('ip_address').innerHTML
                    }
                ],
                "lineItems": line_items
            };
            if (document.getElementById('type_public').checked) {
                // Use the public token.
                callStorefrontAPI(`mutation checkoutCreate($input: CheckoutCreateInput!) {
                  checkoutCreate(input: $input) {
                    checkout {
                      id
                      orderStatusUrl
                      ready
                      requiresShipping
                      lineItems(first: 10) {
                        edges {
                          node {
                            id
                            quantity
                            title
                          }
                        }
                      }
                      webUrl
                    }
                    checkoutUserErrors {
                      code
                      field
                      message
                    }
                    queueToken
                  }
                }`, {
                    "input": input
                }, document.getElementById('ip_address').innerHTML, callback);
            } else {
                // Use the private token (passing the IP address to server side Storefront API).
                accessAppServer('create_checkout', input, document.getElementById('ip_address').innerHTML, callback);
            }
        };

    </script>
</body>

</html>