# Overview
This is _unoffical_ sample code for scratch building [Shopify app](https://shopify.dev/apps) _without_ [CLI automatic cocde generation](https://shopify.dev/apps/getting-started/create) for learing how it works with simple React and GraphQL knowledge.

Making clear, simple, and fewest code is this purpose that's why it doesn't use the CLI generated code.

Reading [Shopify OAuth flow](https://shopify.dev/apps/auth/oauth/getting-started) might help you to grab the basic.

For quick start with automatically generated code, go to the [official CLI tutorial](https://shopify.dev/apps/getting-started/build-app-example).

# Code structure
```
--------- Backend process in a server (Node.js) ---------
app.js ... Koa Node.js app for backend for app install endpoints, GraphQL API calls, and DB access, etc. No Shopify libraries or CLI generated code used.

package.json ... app.js used npm libaries and scripts for building and running this app.

views/ ... holds Koa Node.js dynamic rendering htmls. This is a SPA app which uses index.html only generated by Vite build in frontend.
  ./index.html ... Koa top page view rendered by app.js server code (for code running, this needs replaced with Vite built one).
public/ ... holds static files hosted by app.js server code (for code running, this needs replaced with Vite built one).

--------- Frontend UI in a browser (React) ---------
frontend/ ... React code base to be built by Vite for app admin UI. All built code runs at the client = browser as minized JS + CSS.

  ./src/ ... React source code with JSX of Shopify App Bridge + Polaris.
  ./index.html ... replaces views/index.html as a Vite built file which renders the root React compoment.  
  ./public/ ... Static files used by React code.
  
  ./package.json ... React code used npm libraries and scripts for building React code with Vite.
  ./vite.config.js ... Vite congfig file for building React code into real runnable minized JS + CSS on browsers.

--------- Extensions with Shopify CLI generation and deployment (Liquid/React/JavaScript/Wasm, etc.) ---------
extensions/ ... automatically generated directory and code by Shopify CLI `npm run generate extension`.

  ./my-XXXXX-ext ... each extension (Theme App / Shopify Functions / Checkout UI / Post-purchase / Web Pixels /... etc.) source.
    ../shopify.extension.toml ... each extension configuration required by CLI commands.
```

[React](https://react.dev/) ([JSX](https://react.dev/learn/writing-markup-with-jsx), [Props](https://react.dev/learn/passing-props-to-a-component), [State](https://react.dev/learn/state-a-components-memory), [Hooks](https://react.dev/reference/react/hooks), etc.) and [GraphQL](https://graphql.org/) ([Query](https://graphql.org/learn/queries/), [Edges](https://graphql.org/learn/pagination/#pagination-and-edges), [Union](https://graphql.org/learn/schema/#union-types), etc.) are mandatory technologies for manipulating this sample.


For creating React frontend, the following contents might help you.
- [App Bridge Actions](https://shopify.dev/apps/tools/app-bridge/actions)
- [Polaris Compoments by React](https://polaris.shopify.com/components)

For extensions like Theme App Extensinons, Shopify Functtions, and Checkout Extensions, refer to the [app extensions](https://shopify.dev/docs/apps/build/app-extensions) page.

# How to run
0. Create your Shopify partner account from [here](https://www.shopify.com/partners) and create a Shopify app **manually** (not choosing Shopify CLI) in the app menu of your dashboard. Also, [create a development store](https://shopify.dev/docs/api/development-stores#create-a-development-store-to-test-your-app) to install this app too. If you want to customize this sample code, don't forget to clone (fork) this repository to make your own one.

1. Decide if you run this app locally **or** in cloud hosting serivces like [Render](https://render.com/), [Fly.io](https://fly.io/), [Heroku](https://www.heroku.com/), and [AWS EC2](https://aws.amazon.com/), etc. If you run it locally, you need to use network tunneling tool like [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/downloads/) because your app server url (described as `YOUR_APP_URL` below) needs to be **public**, not localhost directly, so you need to bind your localhost to a public URL. If your company **blocks network tunneling**, you have to choose a cloud hosting serivce. This app has no limtation of hosting serivce choise, but [Render](https://render.com/) is recommneded as they provide free plan, and just conneting a [GitHub repository](../../../shopify-barebone-app-sample) enables you to create a web service, and [Shopify CLI app hosting](https://render.com/docs/deploy-shopify-app) is supported natively with the Docker file.

2. Add the following environmental variables locally (export in the terminal) or in the cloud platform (in environmental variable settings).
    ```
    SHOPIFY_API_KEY:              YOUR_API_KEY (Copy and paste from your app settings in partner dashboard)
    SHOPIFY_API_SECRET:           YOUR_API_SECRET (Copy and paste from your app settings in partner dashboard)
    SHOPIFY_API_VERSION:          unstable         

    SHOPIFY_DB_TYPE:              MONGODB (Default) / POSTGRESQL / MYSQL

    // The followings are required if you set SHOPIFY_DB_TYPE 'MONGODB'
    SHOPIFY_MONGO_DB_NAME:        YOUR_DB_NAME (any name is OK)
    SHOPIFY_MONGO_URL:            mongodb://YOUR_USER:YOUR_PASSWORD@YOUR_DOMAIN:YOUR_PORT/YOUR_DB_NAME

    // The followings are required if you set SHOPIFY_DB_TYPE 'POSTGRESQL'
    SHOPIFY_POSTGRESQL_URL:       postgres://YOUR_USER:YOUR_PASSWORD@YOUR_DOMAIN(:YOUR_PORT)/YOUR_DB_NAME

    // The followings are required if you set SHOPIFY_DB_TYPE 'MYSQL'
    SHOPIFY_MYSQL_HOST:           YOUR_DOMAIN
    SHOPIFY_MYSQL_USER:           YOUR_USER
    SHOPIFY_MYSQL_PASSWORD:       YOUR_PASSWORD
    SHOPIFY_MYSQL_DATABASE:       YOUR_DB_NAME

    // The followings are required if you use `webhookcommon` endpoint as a manually created webhook target.
    SHOPIFY_WEBHOOK_SECRET:       YOUR_TEST_STORE_WEBHOOK_SIGNATURE given by the webhook creation settings

    ```

3.  If you run it locally, run the following build command (`npm install && npm run build`). If you use cloud hosting, specify the build command in the appropriate settings or run it directly. You can see the details of command definition in `package.json`.
    ```
    Build command = npm install && npm run build (= cd frontend && npm install && npm run build && rm -rf ../public/assets && mv dist/assets ../public/assets && mv dist/index.html ../views/index.html  *Replacing Koa intex file with Vite buit code)

    Start command = npm run start (= node app.js)
    ```

4. If you run it locally, install a network tunneling tool like [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/downloads/) and bind your localhost to their provided public URL. If you use cloud hosting, skip this step.
    ```
    `cloudflared tunnel --url localhost:3000` => This provides a dynamic URL like a "https://*********.trycloudflare.com" poiting your localhost to be used for `YOUR_APP_URL` below.
    ```

5. If you use PostgreSQL or MySQL, create the following table in your database (in `psql` or `mysql` command or other tools).
    ```
    For PostgreSQL:

    CREATE TABLE shops ( _id VARCHAR NOT NULL PRIMARY KEY, data json NOT NULL, created_at TIMESTAMP NOT NULL, updated_at TIMESTAMP NOT NULL );

    For MySQL:

    CREATE TABLE shops ( _id VARCHAR(500) NOT NULL PRIMARY KEY, data JSON NOT NULL, created_at TIMESTAMP NOT NULL, updated_at TIMESTAMP NOT NULL );

    ```

6. Create `shopify.app.toml` file in the root directory copied from [this page](https://shopify.dev/docs/apps/tools/cli/configuration) and replace each value as follows.
    - _name_ = `YOUR_APP_NAME`
    - _client_id_ = `SHOPIFY_API_KEY`
    - _application_url_ = `YOUR_APP_URL` (***1**)
    - _handle_ = `YOUR_APP_HANDLE` (In general, lowercase letters of the app name replacing '_' with '-' used for admin URL path for the app and toml file name for multiple app hanlding)
    - _scopes in [access_scopes]_ = "write_products,write_discounts,write_orders,write_payment_customizations,write_delivery_customizations,write_pixels,read_customer_events,write_customers,write_assigned_fulfillment_orders,write_merchant_managed_fulfillment_orders,write_third_party_fulfillment_orders,write_fulfillments,write_inventory,unauthenticated_write_checkouts,unauthenticated_read_product_listings,unauthenticated_write_customers,unauthenticated_read_selling_plans,read_locations"
    - _redirect_urls in [auth]_ = [`YOUR_APP_URL/callback`]
    - _api_version in [webhooks]_ = `SHOPIFY_API_VERSION`
    - _uri in [webhooks.subscriptions]_ = `/webhookgdpr`
    - _url in [app_proxy]_ = `YOUR_APP_URL/appproxy`
    - _subpath in [app_proxy]_ = "bareboneproxy"
    - _prefix in [app_proxy]_ = "apps"
    - _url in [app_preferences]_ = `YOUR_APP_URL`

    ***1** `YOUR_APP_URL` is your network tunneling tool or cloud hosting service's `root` URL. If you add `?external=true` parameter to `YOUR_APP_URL`, the app UX turns into a [service connector](../../../shopify-barebone-app-sample/wiki#for-external-service-connection) which connects Shopify stores with the external dummy serivce. **Note that if you disable the app embedded (non embedeed app), App Bridge and its Session Token cannot be used so this app shows the same external page using its own JWT which contains "shop", instead of Session Token.** (See [this demo](../../../shopify-barebone-app-sample/wiki#non-embedded-apps-cannot-use-app-bridge-or-session-token-so-should-render-the-external-page-with-your-own-jwt))

7. Install [Shopify CLI](https://shopify.dev/docs/api/shopify-cli) and execute `shopify app deploy` and follow its instruction (choose your partner account, connecting to the exising app, include your configuration on deploy = YES, etc.) which registers extensions to your app and create `/.env` file which has extensiton ids used by this sample. For [Shopify Functions](https://shopify.dev/api/functions) deployment using [Rust](https://www.rust-lang.org/), you need to install [Cargo](https://doc.rust-lang.org/cargo/) Wasm package before executing `shopify app deploy` by `cargo install cargo-wasi`.
    If you see the **Cargo specific error** for function build (this typically happens in old Rust environment), try the following commands.
    ```
    rustup target remove wasm32-wasi

    rustup update

    rustup target add wasm32-wasip1
    ```
    If you see the **toml file error** like `Validation errors`, update the field **manually** in the app `Configuration` in your partner dashboard and run again.

8. Go to the app `API access` in your partner dashboard to `Allow network access`. => This is required for [using fetch() in Checkout UI Extensions](../../../shopify-barebone-app-sample/blob/main/extensions/my-checkout-ui-ext/src/Upsell.jsx). 

9. Go to the app `Distribution` in your partner dashboard to select `Public` or `Custom` (if you selected the custom app, use your development store domain for the link). => This is required for [using useShippingAddress() in Checkout UI Extensions](../../../shopify-barebone-app-sample/blob/main/extensions/my-checkout-ui-ext/src/Review.jsx). 

10. If you run it locally, execute the start command (`npm run start`). If you use cloud hosting, specify the start command in the appropriate settings or run it directly. Accessing `YOUR_APP_URL` from the browser shows `Bad request` message, but this is expected. Make sure if no other errors happen like 404 / 500.

# How to install
Access to the following endpoit.
`https://SHOPIFY_SHOP_DOMAIN/admin/oauth/authorize?client_id=YOUR_API_KEY&redirect_uri=YOUR_APP_URL/callback&state=&grant_options[]=`　

Or 

you can install to your development stores from the app `Overview` in your partner dashboard.

# How to update
- For server side update (`app.js` or `views` in Koa), run the start command (`npm run start`) again works. Some cloud services like Render enables it with `git commit & git push`.
- For fronend update (`frontend` in React), run the build command (`npm run build`) again. If you change the value of `SHOPIFY_API_KEY`, you need to build again. Some cloud services like Render enables it with `git commit & git push`.
- For extension update (`extensions`), run `shopify app deploy` again. This needs to be done in your local (development) PC, not in the cloud hosting service.  If you change the value of `SHOPIFY_API_KEY`, you need to deploy again with the toml file updated as described below.

# Sample list
All sample are available at [Wiki](../../wiki).

# TIPS
- If you want to create other language versions of this app like PHP, Java, Ruby, Python, etc., the best way is [creating an extension-only app](https://shopify.dev/docs/apps/app-extensions/extension-only-apps) by **not choosing a Remix template in CLI steps** to add your server side code manually. 
- If you fail to get [protected customer data](https://shopify.dev/docs/apps/store/data-protection/protected-customer-data) in Checkout UI Extension or API Webhook creation even in dev. stores, submit your app first which enable you get them (this is for `public app distribution` only).
- If you update some environment variables shared with `shopify.app.toml` (e.g. `SHOPIFY_API_KEY`), change the coressponding value in the file to run `shopify app deploy` to apply the change to the app configration in partner dashboard (if you change other toml file values, do the same).
- If you manage **multiple apps in this single source code** and swtich the target app, follow the steps below.
    1. Change the environment variables of `SHOPIFY_API_KEY` and `SHOPIFY_API_SECRET` and apply them (export).
    2. Execute `shopify app deploy --reset` and choose the target app (it is supposed to be created manually).
    3. Enter the new toml file name (use `YOUR_APP_HANDLE`) or leave blank for the app.
    4. The new toml file gets generated for the new app with the current config values in partner dashboard.
    5. Remember to replace `scopes in [auth]` with the same value as the original toml file which must be blank by default.
- [Checkout UI Extension Integration Deep Dive](../../wiki/Checkout-UI-Extension-Integration-Deep-Dive) (Japanese version is [here](../../wiki/Checkout-UI-Extension-%E5%AE%9F%E8%A3%85%E8%A9%B3%E7%B4%B0)) help you to understand how the extension work deeply and avoid some pitfalls.

# Disclaimer
- This code is fully _unofficial_ and NOT guaranteed to pass [the public app review](https://shopify.dev/apps/store/review) for Shopify app store. The official requirements are described [here](https://shopify.dev/apps/store/requirements). 
- You need to follow [Shopi API Licene and Terms of Use](https://www.shopify.com/legal/api-terms) even for custom app usage.
- This code is supposed to be used as tutorials mainly for catching up Shopify app dev and does **NOT** guarantees all security covered like [this consideration](https://shopify.dev/docs/api/checkout-ui-extensions/unstable/configuration#network-access). If you use this code for your production, **all resposibilties are owned by you**.
